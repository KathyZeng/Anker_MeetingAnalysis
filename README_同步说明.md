# 飞书多维表格增量同步说明

## 📋 概述

本方案实现了智能的增量同步机制,避免重复读取已处理的表格数据。

## 🗂️ 文件说明

### 1. 配置文件
- **路径**: `input/.processed_tables.json`
- **作用**: 记录已处理的表格列表和同步时间
- **格式**:
```json
{
  "last_sync_time": "2025-11-19T18:39:00",
  "processed_tables": [
    "9月会议详情",
    "10月会议详情",
    ...
  ],
  "source_info": {
    "app_token": "Hioab1CEpa3R8SszroPcMkYin4c",
    "wiki_url": "https://anker-in.feishu.cn/wiki/FybQw1XSzi3AWgk2ps1cQUJPnVg"
  }
}
```

### 2. 同步脚本
- **路径**: `sync_new_tables.py`
- **作用**: 辅助工具,显示当前状态和使用说明

### 3. 数据文件
- **路径**: `input/*.csv`
- **命名**: 与飞书表格名称一致

## 🎯 支持的表格名称格式

### 格式1: 月度会议详情
- 格式: `X月会议详情`
- 示例: `9月会议详情`, `10月会议详情`, `11月会议详情`, `12月会议详情`

### 格式2: 周度会议详情
- 格式: `MM.DD-MM.DD会议详情`
- 示例: `10.20-10.26会议详情`, `11.03-11.09会议详情`, `11.17-11.23会议详情`

## 🚀 使用方法

### 方法1: 最简单 (推荐)

直接告诉Claude Code:

```
请同步飞书表格中的新增数据表
```

或者:

```
请同步新增的会议数据
```

### 方法2: 查看当前状态

```bash
python3 sync_new_tables.py
```

这会显示:
- 已处理的表格列表
- 上次同步时间
- 使用说明

### 方法3: 指定表格名称

如果你知道新增了哪些表格:

```
请读取飞书表格中的以下新表格:
- 11.17-11.23会议详情
- 11.24-11.30会议详情
```

## 🔄 工作流程

```
┌─────────────────────────────────────────────────┐
│  步骤1: 读取飞书表格列表                           │
│  - 调用飞书API获取所有数据表                       │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│  步骤2: 加载已处理记录                             │
│  - 读取 .processed_tables.json                  │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│  步骤3: 识别新增表格                               │
│  - 对比找出未处理的表格                            │
│  - 验证表格名称格式                                │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│  步骤4: 读取并保存新表格                           │
│  - 读取字段信息                                    │
│  - 读取记录数据                                    │
│  - 保存为 CSV 文件到 input/ 目录                  │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│  步骤5: 更新配置文件                               │
│  - 将新处理的表格添加到 processed_tables          │
│  - 更新 last_sync_time                          │
└─────────────────────────────────────────────────┘
```

## 📊 示例场景

### 场景1: 新增周报表格

假设您在飞书中新增了:
- `11.17-11.23会议详情`
- `11.24-11.30会议详情`

**操作**:
```
请同步新增的会议数据
```

**结果**:
- ✅ 只读取这2个新表格
- ✅ 保存到 `input/11.17-11.23会议详情.csv` 和 `input/11.24-11.30会议详情.csv`
- ✅ 更新配置文件,避免下次重复处理
- ❌ 不会重新读取之前的6个表格

### 场景2: 新增月报表格

假设您在飞书中新增了:
- `11月会议详情`

**操作**:
```
请同步飞书表格中的新增数据表
```

**结果**:
- ✅ 只读取 `11月会议详情`
- ✅ 保存到 `input/11月会议详情.csv`
- ✅ 更新配置文件

## ⚙️ 高级配置

### 手动添加已处理表格

如果某些表格不需要处理,可以手动编辑 `input/.processed_tables.json`:

```json
{
  "processed_tables": [
    "9月会议详情",
    "10月会议详情",
    "测试表格"  // 手动添加,下次同步时会跳过
  ]
}
```

### 重置同步记录

如果需要重新处理所有表格:

```bash
# 删除配置文件
rm input/.processed_tables.json

# 或者清空已处理列表
# 编辑文件,将 processed_tables 改为 []
```

然后告诉Claude Code:
```
请同步飞书表格的所有数据表
```

## 🎨 完整示例

### 当前状态
```
已处理的表格 (6个):
1. 9月会议详情
2. 10月会议详情
3. 10.20-10.26会议详情
4. 10.27-11.2会议详情
5. 11.03-11.09会议详情
6. 11.10-11.16会议详情
```

### 飞书新增了表格
```
飞书表格列表 (8个):
1. 9月会议详情              ← 已处理
2. 10月会议详情             ← 已处理
3. 10.20-10.26会议详情      ← 已处理
4. 10.27-11.2会议详情       ← 已处理
5. 11.03-11.09会议详情      ← 已处理
6. 11.10-11.16会议详情      ← 已处理
7. 11.17-11.23会议详情      ← 🆕 新增
8. 11月会议详情             ← 🆕 新增
```

### 执行同步
```
您: 请同步新增的会议数据

Claude Code:
✓ 检测到2个新表格
✓ 正在读取 11.17-11.23会议详情...
✓ 正在读取 11月会议详情...
✓ 保存完成
✓ 更新配置文件

已保存:
- input/11.17-11.23会议详情.csv
- input/11月会议详情.csv
```

## 🔍 故障排查

### 问题1: 表格被重复处理

**原因**: 配置文件丢失或损坏

**解决**: 检查 `input/.processed_tables.json` 是否存在且格式正确

### 问题2: 新表格未被识别

**原因**: 表格名称格式不符合规范

**解决**: 确保表格名称符合以下格式之一:
- `X月会议详情`
- `MM.DD-MM.DD会议详情`

### 问题3: 想要强制重新读取某个表格

**解决**:
```json
// 从配置文件中删除对应的表格名
{
  "processed_tables": [
    "9月会议详情",
    // "10月会议详情",  ← 注释或删除这行
    "11月会议详情"
  ]
}
```

## 📝 注意事项

1. **配置文件位置**: `.processed_tables.json` 文件位于 `input/` 目录下,以点开头表示隐藏文件
2. **文件编码**: 所有CSV文件使用 UTF-8 编码
3. **表格命名**: 保存的CSV文件名与飞书表格名完全一致
4. **自动备份**: 建议定期备份 `input/` 目录下的所有文件

## 🎉 总结

使用本方案后,您只需要:

1. 在飞书中新增表格
2. 告诉Claude Code: "请同步新增的会议数据"
3. Claude Code会自动:
   - 识别新表格
   - 只读取新数据
   - 保存到正确位置
   - 更新记录避免重复

**简单、智能、高效!** 🚀
