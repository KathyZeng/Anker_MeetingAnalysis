# 指标字段调整说明

**创建时间**: 2025-11-20
**调整原因**: 用户需求变更

---

## 🔄 字段定义变更

### 原有字段定义 (V1)

| 指标名称 | 字段名 | 包含范围 |
|---------|--------|---------|
| 日人均线上会议数 | `日人均线上会议数` | **所有会议类型**（即时+日程+1v1） |
| 日人均线上会议时长 | `日人均线上会议时长(分钟)` | **所有会议类型**（即时+日程+1v1） |

### 新的字段定义 (V2)

| 指标名称 | 字段名 | 包含范围 |
|---------|--------|---------|
| 日人均线上会议数 | `日人均线上会议数-即时+日程` | **仅即时+日程**（不含1v1） |
| 日人均线上会议时长 | `日人均线上会议时长(分钟)-即时+日程` | **仅即时+日程**（不含1v1） |
| 即时+日程会议 | `即时+日程会议` | 即时+日程会议总数 |

---

## 📊 具体变更对比

### 变更1: 日人均线上会议数

```python
# V1 原有逻辑
daily_meeting_count = df['日人均线上会议数'].mean()
# 这个字段包含: 即时会议 + 日程会议 + 1v1通话

# V2 新逻辑
daily_meeting_count = df['日人均线上会议数-即时+日程'].mean()
# 这个字段仅包含: 即时会议 + 日程会议
# 排除: 1v1通话
```

**为什么调整？**
- 1v1通话和正式会议的性质不同
- 分开统计更能反映实际会议改善情况

---

### 变更2: 日人均线上会议时长

```python
# V1 原有逻辑
daily_duration = df['日人均线上会议时长(分钟)'].mean()
# 这个字段包含: 即时会议时长 + 日程会议时长 + 1v1通话时长

# V2 新逻辑
daily_duration = df['日人均线上会议时长(分钟)-即时+日程'].mean()
# 这个字段仅包含: 即时会议时长 + 日程会议时长
# 排除: 1v1通话时长
```

---

### 变更3: 新增字段

```python
# V2 新增
instant_scheduled_meetings = df['即时+日程会议'].sum()
# 用途: 明确显示即时和日程会议的总数
```

---

## 📋 CSV文件字段要求更新

### 必需字段（V2）

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| user_name | 文本 | 用户名 | 张三 |
| **日人均线上会议数-即时+日程** | 数字 | 仅即时+日程的平均会议数 | 3.2 |
| **日人均线上会议时长(分钟)-即时+日程** | 数字 | 仅即时+日程的平均时长 | 58.5 |
| 即时会议 | 整数 | 即时会议数量 | 12 |
| 日程会议 | 整数 | 日程会议数量 | 18 |
| 1v1通话数 | 整数 | 1v1通话次数 | 8 |
| **即时+日程会议** | 整数 | 即时+日程会议总数（=即时+日程） | 30 |

### 兼容性处理

为了保证V1数据也能在V2中使用，需要做**字段映射**：

```python
# app/file_manager.py 或 calculator.py 中添加兼容逻辑

def get_daily_meeting_count(df):
    """
    获取日人均会议数（兼容新旧字段）
    """
    # 优先使用新字段
    if '日人均线上会议数-即时+日程' in df.columns:
        return df['日人均线上会议数-即时+日程'].mean()

    # 兼容旧字段（但需要减去1v1）
    if '日人均线上会议数' in df.columns and '1v1通话数' in df.columns:
        # 粗略估算: 总会议数 - 1v1通话
        total = df['日人均线上会议数'].mean()
        calls_1v1 = df['1v1通话数'].mean()
        # 注意: 这只是近似，建议使用新字段
        return total - calls_1v1

    # 如果都没有，返回0
    return 0.0


def get_daily_meeting_duration(df):
    """
    获取日人均会议时长（兼容新旧字段）
    """
    # 优先使用新字段
    if '日人均线上会议时长(分钟)-即时+日程' in df.columns:
        return df['日人均线上会议时长(分钟)-即时+日程'].mean()

    # 兼容旧字段
    if '日人均线上会议时长(分钟)' in df.columns:
        return df['日人均线上会议时长(分钟)'].mean()

    if '日人均线上会议时长' in df.columns:
        return df['日人均线上会议时长'].mean()

    return 0.0


def get_instant_scheduled_meetings(df):
    """
    获取即时+日程会议总数（兼容新旧字段）
    """
    # 优先使用新字段
    if '即时+日程会议' in df.columns:
        return df['即时+日程会议'].sum()

    # 兼容计算: 即时会议 + 日程会议
    instant = df.get('即时会议', df.get('即时会议数', 0)).sum()
    scheduled = df.get('日程会议', df.get('日程会议数', 0)).sum()
    return instant + scheduled
```

---

## 🎯 KPI计算调整

### 调整后的4个主要KPI

#### 1. 日人均线上会议数-即时+日程

```python
# 计算方式
baseline_avg = baseline['日人均线上会议数-即时+日程'].mean()
current_avg = current['日人均线上会议数-即时+日程'].mean()
change_rate = ((current_avg - baseline_avg) / baseline_avg) * 100

# 示例
基线: 3.8 次/天
当前: 3.2 次/天
变化: -0.6 次/天 (-15.79%)
结果: ✅ 改善（会议数下降）
```

#### 2. 日人均线上会议时长-即时+日程

```python
# 计算方式
baseline_duration = baseline['日人均线上会议时长(分钟)-即时+日程'].mean()
current_duration = current['日人均线上会议时长(分钟)-即时+日程'].mean()
change_rate = ((current_duration - baseline_duration) / baseline_duration) * 100

# 示例
基线: 65.3 分钟/天
当前: 58.5 分钟/天
变化: -6.8 分钟/天 (-10.41%)
结果: ✅ 改善（时长下降）
```

#### 3. 即时会议占比

```python
# 计算方式（不变）
instant_ratio = (即时会议数 / 即时+日程会议) * 100

# 示例
基线: 60% (即时12, 日程18, 总30)
当前: 45% (即时9, 日程11, 总20)
变化: -15个百分点
结果: ✅ 改善（即时会议占比下降）
```

#### 4. 会议规模人均参会人数

```python
# 计算方式（使用新字段）
avg_attendees = 会议规模累计参会人次 / 即时+日程会议

# 示例
基线: 152人次 / 30会议 = 5.07人/会议
当前: 96人次 / 20会议 = 4.8人/会议
变化: -0.27人/会议 (-5.32%)
结果: ✅ 改善（小型会议增多）
```

---

## 📂 迁移脚本调整

如果需要将V1的CSV数据转换为V2格式：

```python
# migrate_csv_fields.py
"""
将旧格式CSV转换为新格式CSV
添加新的字段: 日人均线上会议数-即时+日程, 日人均线上会议时长(分钟)-即时+日程, 即时+日程会议
"""

import pandas as pd
import glob

def migrate_csv(input_path, output_path):
    """迁移单个CSV文件"""
    df = pd.read_csv(input_path, encoding='utf-8')

    # 添加新字段（如果不存在）
    if '日人均线上会议数-即时+日程' not in df.columns:
        # 假设旧字段包含1v1，需要减去
        if '日人均线上会议数' in df.columns and '1v1通话数' in df.columns:
            # 注意: 这是粗略估算，实际应该从原始数据重新计算
            df['日人均线上会议数-即时+日程'] = df['日人均线上会议数'] - (df['1v1通话数'] / 工作日数)
        else:
            df['日人均线上会议数-即时+日程'] = df['日人均线上会议数']

    if '日人均线上会议时长(分钟)-即时+日程' not in df.columns:
        # 同样是粗略估算
        df['日人均线上会议时长(分钟)-即时+日程'] = df['日人均线上会议时长(分钟)']

    if '即时+日程会议' not in df.columns:
        instant = df.get('即时会议', df.get('即时会议数', 0))
        scheduled = df.get('日程会议', df.get('日程会议数', 0))
        df['即时+日程会议'] = instant + scheduled

    # 保存
    df.to_csv(output_path, index=False, encoding='utf-8')
    print(f"✅ 已迁移: {input_path} → {output_path}")


def migrate_all():
    """迁移所有CSV"""
    csv_files = glob.glob("input/*.csv")
    for csv_file in csv_files:
        output = csv_file.replace("input/", "input_v2/")
        migrate_csv(csv_file, output)


if __name__ == '__main__':
    migrate_all()
```

**警告**: 上述脚本只是**近似转换**，最好从原始数据源重新导出新字段的CSV。

---

## 🔔 重要提醒

### 1. 数据来源需要调整

如果你的CSV是从某个系统导出的，需要确保导出时：
- ✅ 单独统计"即时+日程会议"的数量和时长
- ✅ 不要将1v1通话计入这两个指标
- ✅ 新增"即时+日程会议"总数字段

### 2. 向后兼容

V2代码将同时支持：
- 新字段: `日人均线上会议数-即时+日程`
- 旧字段: `日人均线上会议数` (但会提示建议使用新字段)

### 3. 界面显示调整

仪表盘上的指标名称将更新为：
```
旧: "日人均线上会议数"
新: "日人均线上会议数（即时+日程）"

旧: "日人均线上会议时长"
新: "日人均线上会议时长（即时+日程）"
```

---

## ✅ 行动清单

在开始生成V2代码前，请确认：

1. **CSV数据源**
   - [ ] 已经从源系统重新导出包含新字段的CSV
   - [ ] 或者可以使用迁移脚本转换旧CSV（精度会降低）

2. **字段命名**
   - [ ] 确认新字段名称: `日人均线上会议数-即时+日程`
   - [ ] 确认新字段名称: `日人均线上会议时长(分钟)-即时+日程`
   - [ ] 确认新字段名称: `即时+日程会议`

3. **向后兼容**
   - [ ] V2需要兼容V1的旧字段（推荐）
   - [ ] 或者强制要求新字段（不推荐）

---

**请确认这个字段调整是否正确？我会在生成V2代码时应用这些变更！** 🎯
