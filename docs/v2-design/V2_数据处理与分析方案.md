# V2 数据处理与分析方案（基于新指标字段）

**创建时间**: 2025-11-20
**版本**: V2.0
**状态**: 最终方案

---

## 📊 CSV字段定义（已确认）

### 实际CSV字段列表

根据你的CSV文件，字段结构如下：

| 字段名 | 数据类型 | 说明 | 示例值 |
|--------|---------|------|--------|
| **user_name** | 文本 | 用户名 | Sam Liu |
| **人的会议数** | 整数 | 总会议数（即时+日程+1v1） | 309 |
| **即时+日程会议** | 整数 | 即时会议+日程会议总数 | 195 |
| **日程会议** | 整数 | 预约的会议数量 | 93 |
| **即时会议** | 整数 | 即时发起的会议数量 | 102 |
| **1v1通话数** | 整数 | 一对一通话次数 | 114 |
| **日人均线上会议数** | 浮点 | 日均所有会议（含1v1） | 14.04545 |
| **日人均线上会议数-即时+日程** | 浮点 | 日均会议（仅即时+日程） | 8.8636 |
| **日人均线上会议时长(分钟)** | 浮点 | 日均时长（含1v1） | 210.1568 |
| **日人均线上会议时长(分钟)-即时+日程** | 浮点 | 日均时长（仅即时+日程） | 190.05455 |

**可选字段**（部分CSV有）:
- **人在线上会议时长**: 整数，周期内总时长（分钟）

---

## 🎯 核心指标体系（基于新字段）

### 主要KPI（4个）

#### 1. 日人均线上会议数-即时+日程 ⭐

**字段**: `日人均线上会议数-即时+日程`

**计算方式**:
```python
baseline_avg = baseline['日人均线上会议数-即时+日程'].mean()
current_avg = current['日人均线上会议数-即时+日程'].mean()
change = current_avg - baseline_avg
change_rate = (change / baseline_avg) * 100
```

**评估标准**:
- 变化率 < 0 → ✅ 改善（会议数下降）
- 变化率 > 0 → ❌ 恶化（会议数上升）

**示例**:
```
基线期（9月+10月）: 8.5 次/天
当前期（最近4周）: 7.2 次/天
变化: -1.3 次/天
变化率: -15.29%
结果: ✅ 改善
```

---

#### 2. 日人均线上会议时长(分钟)-即时+日程 ⭐

**字段**: `日人均线上会议时长(分钟)-即时+日程`

**计算方式**:
```python
baseline_duration = baseline['日人均线上会议时长(分钟)-即时+日程'].mean()
current_duration = current['日人均线上会议时长(分钟)-即时+日程'].mean()
change = current_duration - baseline_duration
change_rate = (change / baseline_duration) * 100
```

**评估标准**:
- 变化率 < 0 → ✅ 改善（时长下降）
- 变化率 > 0 → ❌ 恶化（时长上升）

**示例**:
```
基线期: 185.3 分钟/天
当前期: 165.8 分钟/天
变化: -19.5 分钟/天
变化率: -10.52%
结果: ✅ 改善
```

---

#### 3. 即时会议占比 ⭐

**计算方式**:
```python
# 基线期
baseline_instant_ratio = (baseline['即时会议'].sum() / baseline['即时+日程会议'].sum()) * 100

# 当前期
current_instant_ratio = (current['即时会议'].sum() / current['即时+日程会议'].sum()) * 100

# 变化（注意：这里是百分点差异，不是百分比）
change = current_instant_ratio - baseline_instant_ratio
```

**评估标准**:
- 变化 < 0 → ✅ 改善（即时会议占比下降，计划性增强）
- 变化 > 0 → ❌ 恶化（即时会议占比上升，计划性减弱）

**示例**:
```
基线期: 60.5% (即时: 2580, 日程: 1685, 总: 4265)
当前期: 52.3% (即时: 980, 日程: 895, 总: 1875)
变化: -8.2 个百分点
结果: ✅ 改善
```

---

#### 4. 会议规模人均参会人数 ⭐

**字段**: `会议规模累计参会人次` (如果CSV中有) 或使用近似计算

**计算方式**:
```python
# 如果有"会议规模累计参会人次"字段
baseline_avg_size = baseline['会议规模累计参会人次'].sum() / baseline['即时+日程会议'].sum()
current_avg_size = current['会议规模累计参会人次'].sum() / current['即时+日程会议'].sum()

# 如果没有该字段，使用近似公式（基于经验）
# 暂时跳过，或提示用户补充该字段
```

**评估标准**:
- 优化方向: 保持在合理范围（如3-8人）
- 过大（>10人）→ 会议效率低
- 过小（<3人）→ 建议用1v1

**示例**:
```
基线期: 6.2 人/会议
当前期: 5.4 人/会议
变化: -0.8 人/会议
结果: ✅ 改善（会议规模优化）
```

---

### 辅助指标（用于深度分析）

#### 5. 1v1通话占比

**计算方式**:
```python
calls_1v1_ratio = (data['1v1通话数'].sum() / data['人的会议数'].sum()) * 100
```

**说明**: 1v1通话占比越高，说明沟通方式越灵活

---

#### 6. 日程会议占比

**计算方式**:
```python
scheduled_ratio = (data['日程会议'].sum() / data['即时+日程会议'].sum()) * 100
```

**说明**: 日程会议占比越高，说明会议计划性越强

---

## 🔧 数据处理流程（V2）

### 完整处理流程

```
┌─────────────────────────────────────────────────────────────┐
│  输入: 用户通过Web界面上传CSV                                  │
│  - 文件名: "11.03-11.09会议详情.csv"                          │
│  - 自动识别周期: 2025-11-03 to 2025-11-09                   │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│  Step 1: 文件管理 (file_manager.py)                          │
│  WeeklyDataManager 类                                        │
│                                                              │
│  1. 解析文件名 → 识别周期                                     │
│     parse_filename("11.03-11.09会议详情.csv")                │
│     → {start: "2025-11-03", end: "2025-11-09"}             │
│                                                              │
│  2. 创建周期目录                                              │
│     data/weekly_data/2025-11-03_to_2025-11-09/              │
│                                                              │
│  3. 保存CSV文件                                              │
│     data/weekly_data/2025-11-03_to_2025-11-09/              │
│       └── meeting_data.csv                                  │
│                                                              │
│  4. 读取并验证数据                                            │
│     - 检查必需字段是否存在                                    │
│     - 统计记录数                                             │
│                                                              │
│  5. 更新索引文件                                              │
│     data/weeks_index.json                                   │
│     {                                                        │
│       "weeks": [{                                           │
│         "id": "2025-11-03_to_2025-11-09",                  │
│         "start_date": "2025-11-03",                        │
│         "end_date": "2025-11-09",                          │
│         "record_count": 264,                               │
│         "uploaded_at": "2025-11-20 15:30:00"               │
│       }]                                                    │
│     }                                                        │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│  Step 2: 用户选择周期（Web界面）                              │
│                                                              │
│  基线周期（多选）:                                            │
│    ✓ 2025-09-01 ~ 2025-09-30 (9月会议详情)                 │
│    ✓ 2025-10-01 ~ 2025-10-31 (10月会议详情)                │
│                                                              │
│  对比周期（单选）:                                            │
│    ○ 2025-11-03 ~ 2025-11-09                               │
│    ● 2025-11-10 ~ 2025-11-16                               │
│                                                              │
│  点击 [生成分析报告] 按钮                                     │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│  Step 3: 数据加载 (file_manager.py)                          │
│                                                              │
│  1. 加载基线期数据                                            │
│     baseline_data = []                                      │
│     for week_id in ["2025-09-01_to_2025-09-30",            │
│                     "2025-10-01_to_2025-10-31"]:           │
│         df = load_csv(week_id)                             │
│         baseline_data.append(df)                           │
│     baseline = pd.concat(baseline_data)                    │
│                                                              │
│  2. 加载对比期数据                                            │
│     current = load_csv("2025-11-10_to_2025-11-16")         │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│  Step 4: KPI计算 (calculator.py)                             │
│  MeetingMetricsCalculator 类                                 │
│                                                              │
│  使用新字段计算4个KPI:                                         │
│                                                              │
│  1️⃣ 日人均线上会议数-即时+日程                                │
│     baseline_avg = baseline['日人均线上会议数-即时+日程'].mean() │
│     current_avg = current['日人均线上会议数-即时+日程'].mean()  │
│     change_rate = ((current_avg - baseline_avg) / baseline_avg) * 100 │
│                                                              │
│  2️⃣ 日人均线上会议时长(分钟)-即时+日程                         │
│     baseline_duration = baseline['日人均线上会议时长(分钟)-即时+日程'].mean() │
│     current_duration = current['日人均线上会议时长(分钟)-即时+日程'].mean() │
│     change_rate = ((current_duration - baseline_duration) / baseline_duration) * 100 │
│                                                              │
│  3️⃣ 即时会议占比                                              │
│     baseline_ratio = (baseline['即时会议'].sum() / baseline['即时+日程会议'].sum()) * 100 │
│     current_ratio = (current['即时会议'].sum() / current['即时+日程会议'].sum()) * 100 │
│     change = current_ratio - baseline_ratio                │
│                                                              │
│  4️⃣ 会议规模人均参会人数（如果有该字段）                       │
│     ...                                                     │
│                                                              │
│  输出格式:                                                    │
│  {                                                           │
│    "kpis": {                                                │
│      "日人均线上会议数-即时+日程": {                           │
│        "baseline": 8.5,                                    │
│        "current": 7.2,                                     │
│        "change": -1.3,                                     │
│        "change_rate": -15.29,                              │
│        "improved": true                                    │
│      },                                                     │
│      ...                                                    │
│    }                                                         │
│  }                                                           │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│  Step 5: 深度分析 (analyzer.py)                              │
│  MeetingDataAnalyzer 类                                      │
│                                                              │
│  1. 会议类型分布分析                                          │
│     - 即时会议数、日程会议数、1v1通话数                       │
│     - 各类型占比和变化趋势                                    │
│                                                              │
│  2. 用户分层分析（基于新字段）                                 │
│     - 高频用户: 日人均线上会议数-即时+日程 >= 5               │
│     - 中频用户: 3 <= 日人均线上会议数-即时+日程 < 5          │
│     - 低频用户: 日人均线上会议数-即时+日程 < 3                │
│                                                              │
│  3. Top10用户识别（基于新字段）                               │
│     按 '日人均线上会议数-即时+日程' 排序                      │
│                                                              │
│  4. 异常检测（基于新字段）                                    │
│     - 会议数异常: 日人均线上会议数-即时+日程 > 8             │
│     - 时长异常: 日人均线上会议时长(分钟)-即时+日程 > 240     │
│     - 即时会议过多: 即时会议占比 > 80%                       │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│  Step 6: 返回JSON数据给前端                                   │
│  Flask API接口: /api/analyze                                 │
│                                                              │
│  返回数据结构:                                                │
│  {                                                           │
│    "metadata": {                                            │
│      "baseline_period": "2025-09 ~ 2025-10",              │
│      "current_period": "2025-11-10 ~ 2025-11-16",         │
│      "generated_at": "2025-11-20 15:35:00"                │
│    },                                                        │
│    "kpis": {                                                │
│      "日人均线上会议数-即时+日程": {...},                     │
│      "日人均线上会议时长(分钟)-即时+日程": {...},             │
│      "即时会议占比": {...},                                  │
│      "会议规模人均参会人数": {...}                            │
│    },                                                        │
│    "baseline_stats": {                                      │
│      "即时会议": 2580,                                       │
│      "日程会议": 1685,                                       │
│      "1v1通话": 980,                                        │
│      "即时+日程会议": 4265                                   │
│    },                                                        │
│    "current_stats": {...},                                  │
│    "top10_users": [...],                                    │
│    "user_tiers": {                                          │
│      "high": [...],                                         │
│      "medium": [...],                                       │
│      "low": [...]                                           │
│    },                                                        │
│    "anomalies": [...],                                      │
│    "raw_data": [...]                                        │
│  }                                                           │
└────────────────────┬────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│  Step 7: 前端渲染（JavaScript + ECharts）                     │
│                                                              │
│  1. 接收JSON数据                                             │
│  2. 渲染KPI卡片（4个）                                        │
│  3. 渲染会议类型分布图（饼图）                                │
│  4. 渲染原始数据表                                            │
│  5. 渲染趋势图                                                │
│                                                              │
│  ⚠️ 完全复用V1的样式和图表代码                                │
└─────────────────────────────────────────────────────────────┘
```

---

## 📝 代码实现示例

### calculator.py 核心代码

```python
#!/usr/bin/env python3
"""
指标计算模块（基于新字段）
"""

import pandas as pd
import numpy as np
from typing import Dict

class MeetingMetricsCalculator:
    """会议指标计算器（V2）"""

    def __init__(self, baseline_data: pd.DataFrame, current_data: pd.DataFrame):
        self.baseline_data = baseline_data
        self.current_data = current_data

    def _get_field_value(self, data: pd.DataFrame, field: str, fallback: str = None) -> float:
        """
        获取字段值（带兼容性）

        Args:
            data: 数据DataFrame
            field: 主字段名
            fallback: 备用字段名

        Returns:
            float: 字段的平均值或总和
        """
        if field in data.columns:
            return data[field].mean()

        if fallback and fallback in data.columns:
            return data[fallback].mean()

        return 0.0

    def calculate_kpi_1(self) -> Dict:
        """
        KPI 1: 日人均线上会议数-即时+日程
        """
        baseline_avg = self._get_field_value(
            self.baseline_data,
            '日人均线上会议数-即时+日程',
            '日人均线上会议数'  # 兼容旧字段
        )

        current_avg = self._get_field_value(
            self.current_data,
            '日人均线上会议数-即时+日程',
            '日人均线上会议数'
        )

        change = current_avg - baseline_avg
        change_rate = (change / baseline_avg * 100) if baseline_avg > 0 else 0
        improved = change_rate < 0  # 下降为改善

        return {
            'name': '日人均线上会议数（即时+日程）',
            'unit': '次/天',
            'baseline': round(baseline_avg, 2),
            'current': round(current_avg, 2),
            'change': round(change, 2),
            'change_rate': round(change_rate, 2),
            'improved': improved,
            'trend': '↓' if improved else '↑'
        }

    def calculate_kpi_2(self) -> Dict:
        """
        KPI 2: 日人均线上会议时长(分钟)-即时+日程
        """
        baseline_duration = self._get_field_value(
            self.baseline_data,
            '日人均线上会议时长(分钟)-即时+日程',
            '日人均线上会议时长(分钟)'  # 兼容旧字段
        )

        current_duration = self._get_field_value(
            self.current_data,
            '日人均线上会议时长(分钟)-即时+日程',
            '日人均线上会议时长(分钟)'
        )

        change = current_duration - baseline_duration
        change_rate = (change / baseline_duration * 100) if baseline_duration > 0 else 0
        improved = change_rate < 0

        return {
            'name': '日人均线上会议时长（即时+日程）',
            'unit': '分钟/天',
            'baseline': round(baseline_duration, 2),
            'current': round(current_duration, 2),
            'change': round(change, 2),
            'change_rate': round(change_rate, 2),
            'improved': improved,
            'trend': '↓' if improved else '↑'
        }

    def calculate_kpi_3(self) -> Dict:
        """
        KPI 3: 即时会议占比
        """
        # 基线期
        baseline_instant = self.baseline_data['即时会议'].sum()
        baseline_instant_scheduled = self.baseline_data['即时+日程会议'].sum()
        baseline_ratio = (baseline_instant / baseline_instant_scheduled * 100) if baseline_instant_scheduled > 0 else 0

        # 当前期
        current_instant = self.current_data['即时会议'].sum()
        current_instant_scheduled = self.current_data['即时+日程会议'].sum()
        current_ratio = (current_instant / current_instant_scheduled * 100) if current_instant_scheduled > 0 else 0

        change = current_ratio - baseline_ratio
        improved = change < 0  # 即时会议占比下降为改善

        return {
            'name': '即时会议占比',
            'unit': '%',
            'baseline': round(baseline_ratio, 2),
            'current': round(current_ratio, 2),
            'change': round(change, 2),
            'change_rate': None,  # 百分点差异，不是百分比
            'improved': improved,
            'trend': '↓' if improved else '↑',
            'baseline_detail': {
                '即时会议': int(baseline_instant),
                '即时+日程会议': int(baseline_instant_scheduled)
            },
            'current_detail': {
                '即时会议': int(current_instant),
                '即时+日程会议': int(current_instant_scheduled)
            }
        }

    def calculate_primary_kpis(self) -> Dict:
        """
        计算所有主要KPI
        """
        return {
            '日人均线上会议数-即时+日程': self.calculate_kpi_1(),
            '日人均线上会议时长(分钟)-即时+日程': self.calculate_kpi_2(),
            '即时会议占比': self.calculate_kpi_3()
        }

    def get_baseline_stats(self) -> Dict:
        """
        获取基线期统计数据
        """
        return {
            '即时会议': int(self.baseline_data['即时会议'].sum()),
            '日程会议': int(self.baseline_data['日程会议'].sum()),
            '1v1通话': int(self.baseline_data['1v1通话数'].sum()),
            '即时+日程会议': int(self.baseline_data['即时+日程会议'].sum()),
            '人的会议数': int(self.baseline_data['人的会议数'].sum()),
            '日人均线上会议数-即时+日程': round(self.baseline_data['日人均线上会议数-即时+日程'].mean(), 2),
            '日人均线上会议时长(分钟)-即时+日程': round(self.baseline_data['日人均线上会议时长(分钟)-即时+日程'].mean(), 2)
        }

    def get_current_stats(self) -> Dict:
        """
        获取当前期统计数据
        """
        return {
            '即时会议': int(self.current_data['即时会议'].sum()),
            '日程会议': int(self.current_data['日程会议'].sum()),
            '1v1通话': int(self.current_data['1v1通话数'].sum()),
            '即时+日程会议': int(self.current_data['即时+日程会议'].sum()),
            '人的会议数': int(self.current_data['人的会议数'].sum()),
            '日人均线上会议数-即时+日程': round(self.current_data['日人均线上会议数-即时+日程'].mean(), 2),
            '日人均线上会议时长(分钟)-即时+日程': round(self.current_data['日人均线上会议时长(分钟)-即时+日程'].mean(), 2)
        }
```

---

## ✅ 字段验证清单

在生成V2项目前，确保CSV包含以下字段：

### 必需字段（优先级1）
- [x] `user_name`
- [x] `日人均线上会议数-即时+日程`
- [x] `日人均线上会议时长(分钟)-即时+日程`
- [x] `即时会议`
- [x] `日程会议`
- [x] `即时+日程会议`
- [x] `1v1通话数`
- [x] `人的会议数`

### 兼容字段（优先级2，向后兼容）
- [x] `日人均线上会议数`（旧字段）
- [x] `日人均线上会议时长(分钟)`（旧字段）

### 可选字段（优先级3）
- [ ] `会议规模累计参会人次`（用于计算人均参会人数）
- [x] `人在线上会议时长`（部分CSV有）

---

## 🎯 总结

### V2 相比 V1 的改进

| 方面 | V1 | V2 |
|------|----|----|
| **核心指标** | 包含1v1通话 | 仅统计即时+日程会议 |
| **字段名称** | `日人均线上会议数` | `日人均线上会议数-即时+日程` |
| **灵活性** | 硬编码基线期 | 用户动态选择周期 |
| **数据管理** | 散乱CSV | 按周组织+JSON索引 |
| **操作方式** | 命令行 | Web界面 |
| **实时性** | 每次重新生成HTML | 实时计算并渲染 |

### 核心优势

1. ✅ **指标更精准**: 分离1v1通话，聚焦正式会议
2. ✅ **向后兼容**: 同时支持新旧字段
3. ✅ **灵活对比**: 可选择任意周期对比
4. ✅ **易于管理**: 文件系统组织清晰
5. ✅ **用户友好**: Web界面操作简单

---

**该方案已准备就绪，可以开始生成V2项目代码！** 🚀
